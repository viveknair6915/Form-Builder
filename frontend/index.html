<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder - MERN Stack Assignment</title>
    <!-- Tailwind CSS Inline Styles -->
    <script>
        // Fallback if CDN fails - basic styling will still work
        if (!window.tailwind) {
            console.log('Loading fallback CSS...');
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Fallback CSS in case Tailwind doesn't load */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .fallback-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .fallback-btn { background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        .fallback-btn:hover { background: #5856eb; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .drag-over {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.1) !important;
        }
        .question-card {
            transition: all 0.3s ease;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="glass backdrop-blur-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white">üöÄ Form Builder</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('home')" class="text-white hover:text-purple-200 transition-colors">Home</button>
                    <button onclick="showPage('builder')" class="bg-white text-primary px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">Create Form</button>
                    <button onclick="showPage('forms')" class="text-white hover:text-purple-200 transition-colors">View Forms</button>
                    <button onclick="testAPI()" class="text-white hover:text-purple-200 transition-colors">Test API</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="home-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-6xl mx-auto text-center">
            <div class="glass rounded-3xl p-8 mb-8">
                <h2 class="text-5xl font-bold text-white mb-6">Custom Form Builder</h2>
                <p class="text-xl text-gray-200 mb-8">Create interactive forms with advanced question types</p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <!-- Categorize Card -->
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow question-card">
                        <div class="text-4xl mb-4">üìä</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Categorize Questions</h3>
                        <p class="text-gray-600">Drag and drop items into correct categories with intuitive interface</p>
                    </div>
                    
                    <!-- Cloze Card -->
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow question-card">
                        <div class="text-4xl mb-4">üìù</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Cloze Questions</h3>
                        <p class="text-gray-600">Fill-in-the-blank questions with drag and drop word options</p>
                    </div>
                    
                    <!-- Comprehension Card -->
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow question-card">
                        <div class="text-4xl mb-4">üìñ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Comprehension Questions</h3>
                        <p class="text-gray-600">Multiple choice questions with rich text and image support</p>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="showPage('builder')" class="bg-white text-primary px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors text-lg">
                        üéØ Create New Form
                    </button>
                    <button onclick="showPage('forms')" class="glass border border-white text-white px-8 py-3 rounded-lg font-bold hover:bg-white hover:text-primary transition-colors text-lg">
                        üìã View All Forms
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Builder Page -->
    <div id="builder-page" class="hidden min-h-screen p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Builder Header -->
            <div class="glass rounded-xl p-6 mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">Form Builder</h2>
                        <p class="text-gray-200">Create your custom form with advanced question types</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="previewForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            üëÅÔ∏è Preview
                        </button>
                        <button onclick="showPage('home')" class="text-white hover:text-purple-200 transition-colors">‚Üê Back to Home</button>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Form Configuration Panel -->
                <div class="lg:col-span-1">
                    <div class="glass rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-white mb-4">Form Settings</h3>
                        
                        <!-- Form Title -->
                        <div class="mb-4">
                            <label class="block text-white font-medium mb-2">Form Title *</label>
                            <input type="text" id="formTitle" placeholder="Enter form title..." 
                                   class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        
                        <!-- Form Description -->
                        <div class="mb-4">
                            <label class="block text-white font-medium mb-2">Description</label>
                            <textarea id="formDescription" placeholder="Enter form description..." rows="3"
                                      class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
                        </div>
                        
                        <!-- Header Image Upload -->
                        <div class="mb-6">
                            <label class="block text-white font-medium mb-2">Header Image</label>
                            <div id="headerImageDrop" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors">
                                <div class="text-gray-600">
                                    <svg class="mx-auto h-12 w-12 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <p class="text-sm font-medium">Drop header image here or click to upload</p>
                                    <p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
                                </div>
                                <input type="file" id="headerImageInput" accept="image/*" class="hidden">
                            </div>
                            <div id="headerImagePreview" class="hidden mt-2">
                                <img id="headerImageDisplay" class="w-full h-32 object-cover rounded-lg">
                                <button onclick="removeHeaderImage()" class="mt-2 text-red-400 hover:text-red-300 text-sm">Remove Image</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Question Types -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Add Questions</h3>
                        <div class="space-y-3">
                            <button onclick="addQuestion('categorize')" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                                <span class="mr-2">üìä</span> Add Categorize Question
                            </button>
                            <button onclick="addQuestion('cloze')" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                                <span class="mr-2">üìù</span> Add Cloze Question
                            </button>
                            <button onclick="addQuestion('comprehension')" 
                                    class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                                <span class="mr-2">üìñ</span> Add Comprehension Question
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-300">
                            <button onclick="saveForm()" 
                                    class="w-full bg-white text-primary px-4 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
                                üíæ Save Form
                            </button>
                            <button onclick="testAllFunctions()" 
                                    class="w-full mt-2 glass border border-white text-white px-4 py-2 rounded-lg font-medium hover:bg-white hover:text-primary transition-colors">
                                üß™ Test All Functions
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div class="lg:col-span-2">
                    <div class="glass rounded-xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">Form Questions</h3>
                            <span id="questionCount" class="text-gray-200">0 questions</span>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="empty-state" class="text-center py-12">
                            <div class="text-gray-400 text-6xl mb-4">üìù</div>
                            <h4 class="text-xl font-medium text-gray-300 mb-2">No questions yet</h4>
                            <p class="text-gray-400">Add your first question using the buttons on the left</p>
                        </div>
                        
                        <!-- Questions Container -->
                        <div id="questions-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Preview/Fill Page -->
    <div id="preview-page" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <div class="glass rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">Form Preview & Fill</h2>
                    <div class="flex space-x-3">
                        <button onclick="submitFormResponse()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            ‚úÖ Submit Response
                        </button>
                        <button onclick="showPage('builder')" class="text-white hover:text-purple-200 transition-colors">‚Üê Back to Editor</button>
                    </div>
                </div>
            </div>
            
            <div id="form-preview-content" class="bg-white rounded-xl p-8 shadow-lg">
                <!-- Preview content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Forms List Page -->
    <div id="forms-list-page" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <div class="glass rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">All Forms</h2>
                    <button onclick="showPage('home')" class="text-white hover:text-purple-200 transition-colors">‚Üê Back to Home</button>
                </div>
            </div>
            
            <div id="forms-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Forms will be populated here -->
            </div>
            
            <div id="forms-empty" class="hidden text-center py-12">
                <div class="glass rounded-xl p-8">
                    <div class="text-gray-400 text-6xl mb-4">üìã</div>
                    <h4 class="text-xl font-medium text-white mb-2">No forms created yet</h4>
                    <p class="text-gray-300 mb-6">Create your first form to get started</p>
                    <button onclick="showPage('builder')" class="bg-white text-primary px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
                        Create Form
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let questions = [];
        let questionCounter = 0;
        let currentFormId = null;
        let headerImageUrl = null;

        // Page navigation
        function showPage(page) {
            // Hide all pages
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('builder-page').classList.add('hidden');
            document.getElementById('preview-page').classList.add('hidden');
            document.getElementById('forms-list-page').classList.add('hidden');
            
            // Show selected page
            switch(page) {
                case 'home':
                    document.getElementById('home-page').classList.remove('hidden');
                    break;
                case 'builder':
                    document.getElementById('builder-page').classList.remove('hidden');
                    break;
                case 'preview':
                    document.getElementById('preview-page').classList.remove('hidden');
                    break;
                case 'forms':
                    document.getElementById('forms-list-page').classList.remove('hidden');
                    loadAllForms();
                    break;
            }
            
            debugLog('Navigated to page: ' + page);
        }

        // Debug logging
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] Form Builder:`, message, data || '');
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 4000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Header image handling
        function setupHeaderImageUpload() {
            const dropArea = document.getElementById('headerImageDrop');
            const input = document.getElementById('headerImageInput');
            
            dropArea.addEventListener('click', () => input.click());
            dropArea.addEventListener('dragover', handleDragOver);
            dropArea.addEventListener('drop', handleDrop);
            input.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        }

        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size must be less than 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                headerImageUrl = e.target.result;
                document.getElementById('headerImageDisplay').src = headerImageUrl;
                document.getElementById('headerImagePreview').classList.remove('hidden');
                showNotification('Header image uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function removeHeaderImage() {
            headerImageUrl = null;
            document.getElementById('headerImagePreview').classList.add('hidden');
            document.getElementById('headerImageInput').value = '';
            showNotification('Header image removed', 'info');
        }

        // Question management
        function addQuestion(type) {
            debugLog('Adding question of type: ' + type);
            
            try {
                questionCounter++;
                const question = {
                    id: questionCounter,
                    type: type,
                    title: `${type.charAt(0).toUpperCase() + type.slice(1)} Question ${questionCounter}`,
                    details: getQuestionDetails(type),
                    image: null
                };
                
                questions.push(question);
                debugLog('Question added successfully. Total questions: ' + questions.length);
                updateQuestionsList();
                
                showNotification(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} question added!`, 'success');
                
            } catch (error) {
                debugLog('Error adding question: ' + error.message);
                showNotification('‚ùå Error adding question: ' + error.message, 'error');
            }
        }

        function getQuestionDetails(type) {
            switch(type) {
                case 'categorize':
                    return {
                        description: 'Drag and drop items into correct categories',
                        categories: [
                            { name: 'Category 1', items: ['Item 1', 'Item 2'] },
                            { name: 'Category 2', items: ['Item 3', 'Item 4'] }
                        ]
                    };
                case 'cloze':
                    return {
                        description: 'Fill in the blanks with correct words',
                        text: 'The quick _____ fox jumps over the lazy _____.',
                        blanks: [
                            { id: 'blank1', answer: 'brown' },
                            { id: 'blank2', answer: 'dog' }
                        ],
                        options: ['brown', 'dog', 'fast', 'cat']
                    };
                case 'comprehension':
                    return {
                        description: 'Multiple choice question based on text passage',
                        passage: 'Read the following passage carefully and answer the question below.',
                        questions: [{
                            question: 'What is the main idea of the passage?',
                            options: ['Option A', 'Option B', 'Option C', 'Option D'],
                            correctAnswer: 0
                        }]
                    };
                default:
                    return {};
            }
        }

        function updateQuestionsList() {
            const questionsList = document.getElementById('questions-list');
            const emptyState = document.getElementById('empty-state');
            const questionCount = document.getElementById('questionCount');
            
            questionCount.textContent = `${questions.length} question${questions.length !== 1 ? 's' : ''}`;
            
            if (questions.length === 0) {
                emptyState.style.display = 'block';
                questionsList.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const questionsHTML = questions.map((q, index) => {
                let preview = getQuestionPreview(q);
                
                return `
                    <div class="bg-white rounded-lg p-6 shadow-lg question-card">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${getQuestionIcon(q.type)}</span>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800">${q.title}</h4>
                                    <span class="inline-block bg-${getQuestionColor(q.type)}-100 text-${getQuestionColor(q.type)}-800 px-2 py-1 rounded-full text-sm font-medium">
                                        ${q.type.charAt(0).toUpperCase() + q.type.slice(1)}
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editQuestion(${q.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="addQuestionImage(${q.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    üñºÔ∏è Image
                                </button>
                                <button onclick="removeQuestion(${q.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                        ${q.image ? `<img src="${q.image}" class="w-full h-32 object-cover rounded-lg mb-4">` : ''}
                        <div class="text-gray-600">${preview}</div>
                    </div>
                `;
            }).join('');
            
            questionsList.innerHTML = questionsHTML;
        }

        function getQuestionIcon(type) {
            const icons = {
                categorize: 'üìä',
                cloze: 'üìù',
                comprehension: 'üìñ'
            };
            return icons[type] || '‚ùì';
        }

        function getQuestionColor(type) {
            const colors = {
                categorize: 'blue',
                cloze: 'green',
                comprehension: 'purple'
            };
            return colors[type] || 'gray';
        }

        function getQuestionPreview(question) {
            switch(question.type) {
                case 'categorize':
                    return `<strong>Categories:</strong> ${question.details.categories.map(c => c.name).join(', ')}`;
                case 'cloze':
                    return `<strong>Text:</strong> "${question.details.text}"`;
                case 'comprehension':
                    return `<strong>Passage:</strong> ${question.details.passage.substring(0, 100)}...`;
                default:
                    return question.details.description || 'No preview available';
            }
        }

        function editQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (question) {
                showNotification(`Editing ${question.type} question (ID: ${id})`, 'info');
                debugLog('Edit question clicked for ID: ' + id, question);
            }
        }

        function addQuestionImage(id) {
            const question = questions.find(q => q.id === id);
            if (question) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            question.image = e.target.result;
                            updateQuestionsList();
                            showNotification('Image added to question!', 'success');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            }
        }

        function removeQuestion(id) {
            debugLog('Removing question with ID: ' + id);
            
            try {
                const questionsBefore = questions.length;
                questions = questions.filter(q => q.id !== id);
                const questionsAfter = questions.length;
                
                if (questionsBefore > questionsAfter) {
                    updateQuestionsList();
                    showNotification('‚úÖ Question removed successfully!', 'success');
                    debugLog('Question removed. Remaining questions: ' + questions.length);
                } else {
                    showNotification('‚ùå Question not found', 'error');
                }
            } catch (error) {
                debugLog('Error removing question: ' + error.message);
                showNotification('‚ùå Error removing question', 'error');
            }
        }

        // Form operations
        function saveForm() {
            debugLog('Saving form...');
            
            const formTitle = document.getElementById('formTitle').value;
            const formDescription = document.getElementById('formDescription').value;
            
            if (!formTitle.trim()) {
                showNotification('‚ùå Please enter a form title!', 'error');
                return;
            }
            
            if (questions.length === 0) {
                showNotification('‚ùå Please add at least one question!', 'error');
                return;
            }
            
            // Prepare questions for backend (remove frontend-only fields)
            const backendQuestions = questions.map(q => {
                if (q.type === 'categorize') {
                    // Backend expects categories: [String], items: [String]
                    const categoryNames = (q.details.categories || []).map(c => c.name);
                    // Collect all items from all categories and from unassigned items
                    let itemsArr = [];
                    if (Array.isArray(q.details.items)) {
                        itemsArr = itemsArr.concat(q.details.items);
                    }
                    (q.details.categories || []).forEach(cat => {
                        if (Array.isArray(cat.items)) {
                            itemsArr = itemsArr.concat(cat.items);
                        }
                    });
                    return {
                        type: q.type,
                        title: q.title,
                        image: q.image,
                        categories: categoryNames,
                        items: itemsArr,
                        description: q.details.description
                    };
                } else if (q.type === 'cloze') {
                    return {
                        type: q.type,
                        title: q.title,
                        image: q.image,
                        text: q.details.text,
                        options: q.details.options,
                        blanks: q.details.blanks,
                        description: q.details.description
                    };
                } else if (q.type === 'comprehension') {
                    return {
                        type: q.type,
                        title: q.title,
                        image: q.image,
                        passage: q.details.passage,
                        questions: q.details.questions,
                        description: q.details.description
                    };
                } else {
                    return {
                        type: q.type,
                        title: q.title,
                        image: q.image,
                        ...q.details
                    };
                }
            });
            
            const formData = {
                title: formTitle.trim(),
                description: formDescription.trim(),
                headerImage: headerImageUrl,
                questions: backendQuestions,
                createdAt: new Date().toISOString()
            };
            
            debugLog('Form data prepared:', formData);
            showNotification('üíæ Saving form...', 'info');
            
            // Send to backend
            fetch('https://form-builder-4mtj.onrender.com/api/forms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                currentFormId = data._id;
                showNotification('‚úÖ Form saved successfully!', 'success');
                debugLog('Form saved:', data);
                
                // Reset form
                document.getElementById('formTitle').value = '';
                document.getElementById('formDescription').value = '';
                removeHeaderImage();
                questions = [];
                questionCounter = 0;
                updateQuestionsList();
                
                setTimeout(() => {
                    showPage('home');
                }, 1500);
            })
            .catch(error => {
                debugLog('Error saving form:', error);
                showNotification('‚ö†Ô∏è Error saving form: ' + error.message, 'error');
            });
        }

        function previewForm() {
            const formTitle = document.getElementById('formTitle').value;
            const formDescription = document.getElementById('formDescription').value;
            
            if (!formTitle.trim()) {
                showNotification('‚ùå Please enter a form title to preview!', 'error');
                return;
            }
            
            if (questions.length === 0) {
                showNotification('‚ùå Please add at least one question to preview!', 'error');
                return;
            }
            
            generateFormPreview(formTitle, formDescription);
            showPage('preview');
        }

        function generateFormPreview(title, description) {
            const previewContent = document.getElementById('form-preview-content');
            
            let html = `
                <div class="mb-8">
                    ${headerImageUrl ? `<img src="${headerImageUrl}" class="w-full h-48 object-cover rounded-lg mb-6">` : ''}
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">${title}</h1>
                    ${description ? `<p class="text-gray-600 text-lg mb-6">${description}</p>` : ''}
                </div>
            `;
            
            questions.forEach((question, index) => {
                html += generateQuestionPreview(question, index + 1);
            });
            
            previewContent.innerHTML = html;
        }

        function generateQuestionPreview(question, number) {
            let html = `
                <div class="border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">
                        ${number}. ${question.title}
                    </h3>
                    ${question.image ? `<img src="${question.image}" class="w-full max-w-md h-32 object-cover rounded-lg mb-4">` : ''}
            `;
            
            switch(question.type) {
                case 'categorize':
                    html += generateCategorizePreview(question);
                    break;
                case 'cloze':
                    html += generateClozePreview(question);
                    break;
                case 'comprehension':
                    html += generateComprehensionPreview(question);
                    break;
            }
            
            html += `</div>`;
            return html;
        }

        function generateCategorizePreview(question) {
            // Show unassigned items and categories with their items
            let unassignedItems = question.details.items ? [...question.details.items] : [];
            (question.details.categories || []).forEach(cat => {
                if (Array.isArray(cat.items)) {
                    cat.items.forEach(item => {
                        const idx = unassignedItems.indexOf(item);
                        if (idx !== -1) unassignedItems.splice(idx, 1);
                    });
                }
            });
            return `
                <p class="text-gray-600 mb-4">${question.details.description}</p>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Items to categorize:</h4>
                        <div class="space-y-2">
                            ${unassignedItems.map(item => 
                                `<div class="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg cursor-move">${item}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">Categories:</h4>
                        <div class="space-y-2">
                            ${(question.details.categories || []).map(cat => 
                                `<div class="border-2 border-dashed border-gray-300 p-4 rounded-lg min-h-[80px]">
                                    <strong>${cat.name}</strong><br>
                                    ${(cat.items && cat.items.length > 0) ? cat.items.map(i => `<span class='inline-block bg-blue-200 text-blue-900 px-2 py-1 rounded m-1'>${i}</span>`).join('') : '<span class="text-gray-400">(No items)</span>'}
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateClozePreview(question) {
            // Render the cloze sentence with input fields for blanks
            let sentenceHtml = '';
            let blankIdx = 0;
            (question.details.text || '').split(/(_+)/).forEach(part => {
                if (part === '_') {
                    sentenceHtml += `<input type="text" class="border-b-2 border-gray-400 w-16 mx-1 px-1" data-blank-idx="${blankIdx}" value="" />`;
                    blankIdx++;
                } else {
                    sentenceHtml += part;
                }
            });
            return `
                <p class="text-gray-600 mb-4">${question.details.description}</p>
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-lg">${sentenceHtml}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Available words:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${(question.details.options || []).map(option => 
                            `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg cursor-move">${option}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function generateComprehensionPreview(question) {
            return `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-gray-700">${question.details.passage}</p>
                </div>
                ${question.details.questions.map((q, i) => `
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-800 mb-3">${q.question}</h4>
                        <div class="space-y-2">
                            ${q.options.map((option, j) => `
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="radio" name="question_${question.id}_${i}" value="${j}" class="text-primary">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function submitFormResponse() {
            showNotification('üìù Form response submitted! (This would save to database)', 'success');
            // In a real implementation, this would collect all form responses and save them
        }

        function loadAllForms() {
            fetch('https://form-builder-4mtj.onrender.com/api/forms')
                .then(response => response.json())
                .then(forms => {
                    displayForms(forms);
                })
                .catch(error => {
                    console.error('Error loading forms:', error);
                    showNotification('Error loading forms', 'error');
                });
        }

        function displayForms(forms) {
            const formsGrid = document.getElementById('forms-grid');
            const formsEmpty = document.getElementById('forms-empty');
            
            if (forms.length === 0) {
                formsGrid.classList.add('hidden');
                formsEmpty.classList.remove('hidden');
                return;
            }
            
            formsGrid.classList.remove('hidden');
            formsEmpty.classList.add('hidden');
            
            const formsHTML = forms.map(form => `
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow question-card">
                    ${form.headerImage ? `<img src="${form.headerImage}" class="w-full h-32 object-cover rounded-lg mb-4">` : ''}
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${form.title}</h3>
                    <p class="text-gray-600 mb-4">${form.description || 'No description'}</p>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm text-gray-500">${form.questions.length} question${form.questions.length !== 1 ? 's' : ''}</span>
                        <span class="text-sm text-gray-500">${new Date(form.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewForm('${form._id}')" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-600 transition-colors">
                            üëÅÔ∏è View
                        </button>
                        <button onclick="fillForm('${form._id}')" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition-colors">
                            üìù Fill
                        </button>
                    </div>
                </div>
            `).join('');
            
            formsGrid.innerHTML = formsHTML;
        }

        function viewForm(formId) {
            showNotification(`Viewing form: ${formId}`, 'info');
            // Implementation would load and display the form
        }

        function fillForm(formId) {
            showNotification(`Opening form for filling: ${formId}`, 'info');
            // Implementation would open the form in fill mode
        }

        function testAPI() {
            debugLog('Testing API connection...');
            showNotification('üîç Testing API connection...', 'info');
            
            fetch('https://form-builder-4mtj.onrender.com/api/forms')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification(`‚úÖ API is working! Found ${data.length} forms.`, 'success');
                    debugLog('API test successful. Forms found:', data.length);
                })
                .catch(error => {
                    debugLog('API Error:', error);
                    showNotification('‚ùå API test failed: ' + error.message, 'error');
                });
        }

        function testAllFunctions() {
            debugLog('Testing all functions...');
            showNotification('üß™ Testing all functions...', 'info');
            
            setTimeout(() => addQuestion('categorize'), 500);
            setTimeout(() => addQuestion('cloze'), 1000);
            setTimeout(() => addQuestion('comprehension'), 1500);
            setTimeout(() => showNotification('üéâ All functions working perfectly!', 'success'), 2000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Form Builder Application Loaded');
            showPage('home');
            setupHeaderImageUpload();
            showNotification('üöÄ Form Builder loaded successfully!', 'success');
        });

        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            debugLog('JavaScript Error: ' + msg + ' at line ' + lineNo);
            showNotification('‚ùå JavaScript Error: ' + msg, 'error');
            return false;
        };
    </script>
</body>
</html>
